<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Koalitionsrechner – Proportionale Sitzverteilung</title>
<style>
  :root {
    --bg:#0b0f14; --card:#121823; --ink:#e8eef7; --muted:#a6b0bf;
    --ok:#37d07a; --bad:#ff6a6a; --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:32px; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    background:radial-gradient(1200px 800px at 80% -20%, #1b2b45 0%, #0b0f14 55%);
  }
  h1{margin:0 0 8px; font-size:clamp(20px,2.6vw,32px)}
  p.sub{margin:0 0 24px; color:var(--muted)}
  .wrap{display:grid; gap:16px; grid-template-columns:380px 1fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius); padding:16px;
  }
  .row{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap}
  .row>*{flex:1}
  input,select,button{
    border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0f1420; color:var(--ink); padding:10px 12px;
  }
  input[type="color"]{padding:0; height:38px; width:100%}
  button{cursor:pointer; font-weight:600}
  button.secondary{background:#0f1420}
  .party-row{
    display:grid; grid-template-columns:26px 1.3fr .9fr .7fr 1fr 26px;
    gap:8px; align-items:center; margin:8px 0;
  }
  .party-row .handle{opacity:.6; text-align:center; font-size:12px}
  .party-row .del{opacity:.7; cursor:pointer; text-align:center}
  .legend{display:flex; flex-wrap:wrap; gap:8px}
  .legend .item{
    display:flex; align-items:center; gap:8px; font-size:13px;
    background:#0f1420; border:1px solid rgba(255,255,255,.08);
    padding:6px 10px; border-radius:999px;
  }
  .sw{width:14px; height:14px; border-radius:4px; display:inline-block; border:1px solid rgba(255,255,255,.3)}
  .pill{display:inline-flex; align-items:center; gap:8px; font-size:13px; padding:6px 10px; border-radius:999px; background:#0f1420; border:1px solid rgba(255,255,255,.08)}
  .checklist{display:flex; flex-wrap:wrap; gap:10px}
  .checklist label{display:flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:999px; background:#0f1420}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  svg{display:block; width:100%; height:auto}
  .arc{opacity:1; transition:opacity .25s ease, transform .25s ease}
  .arc.enter{opacity:0; transform:scale(0.98)}
  .arc.leave{opacity:0; transform:scale(1.02)}
</style>
</head>
<body>
  <h1>Koalitionsrechner – Proportionale Sitzverteilung</h1>
  <p class="sub">Koalition links im Halbkreis (in deiner Listen-Reihenfolge) – sanfte Animation beim Anklicken.</p>

  <div class="wrap">
    <section class="card" id="inputsCard">
      <div class="row">
        <div><label>Gesamtsitze</label><input id="totalSeats" type="number" value="630"></div>
        <div><label>Sperrklausel (%)</label><input id="threshold" type="number" value="5" step="0.1"></div>
      </div>
      <div class="row">
        <div><label>Wahlverfahren</label>
          <select id="method">
            <option value="sls" selected>Sainte-Laguë/Schepers</option>
            <option value="dhondt">d’Hondt</option>
            <option value="hare">Hare-Niemeyer</option>
          </select>
        </div>
        <div><label>Ausnahmen (z. B. SSW)</label><input id="exceptions" placeholder="SSW"></div>
      </div>
      <div class="row" style="justify-content:space-between">
        <button id="addRowBtn" type="button">+ Partei hinzufügen</button>
        <div style="display:flex; gap:8px">
          <button id="resetBtn" class="secondary" type="button">Zurücksetzen</button>
          <button id="calcBtn" type="button">Neu berechnen</button>
        </div>
      </div>
      <div class="muted" style="margin:6px 0 4px">Parteien & Prozentwerte (Name, % und Farbe frei wählbar)</div>
      <div id="partyList"></div>
    </section>

    <section class="card">
      <svg id="seatChart" viewBox="0 0 900 620" preserveAspectRatio="xMidYMin meet"></svg>
      <div class="legend" id="legend"></div>

      <div class="row" style="margin-top:12px">
        <div class="pill"><strong>Mehrheitsschwelle:</strong> <span id="majorityLbl">316</span></div>
        <div class="pill"><strong>Sitze Koalition:</strong> <span id="coalSeats">0</span></div>
        <div class="pill"><strong>Mehrheit?</strong> <span id="coalMajority" class="bad">nein</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Koalitionen testen</h3>
        <div class="checklist" id="coalitionChecklist"></div>
      </div>
    </section>
  </div>

<script>
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let selectedCoalition = new Set();
const GREY = "#b7bdc7";

/* ===== Defaults ===== */
const defaultParties = [
  {name:"CDU/CSU", color:"#000000", pct:28.0, exception:false},
  {name:"SPD",     color:"#E3000F", pct:17.0, exception:false},
  {name:"Grüne",   color:"#1FA12E", pct:12.0, exception:false},
  {name:"FDP",     color:"#FFED00", pct:6.0,  exception:false},
  {name:"AfD",     color:"#009EE0", pct:20.0, exception:false},
  {name:"Linke",   color:"#BE3075", pct:6.0,  exception:false},
  {name:"BSW",     color:"#FF6A00", pct:7.0,  exception:false},
  {name:"Andere",  color:"#7e8799", pct:4.0,  exception:false}
];

/* ===== Inputs lesen ===== */
function readInputs(){
  const totalSeats = parseInt($("#totalSeats").value) || 0;
  const threshold  = parseFloat($("#threshold").value) || 0;
  const method     = $("#method").value;
  const exc        = ($("#exceptions").value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const partyRows  = $$("#partyList .party-row");
  const parties    = partyRows.map(row => ({
    name: row.querySelector(".pName").value.trim() || "Partei",
    color: row.querySelector(".pColor").value,
    pct: parseFloat(row.querySelector(".pPct").value) || 0,
    exception: row.querySelector(".pExc").checked
  }));
  return {totalSeats, threshold, method, exceptions:exc, parties};
}

/* ===== UI bauen ===== */
function setDefaults(){
  $("#partyList").innerHTML = "";
  defaultParties.forEach(addPartyRow);
  calcAndRender();
}

function addPartyRow(p = {name:"Neue Partei", color:"#8888ff", pct:0, exception:false}){
  const row = document.createElement("div");
  row.className = "party-row";
  row.innerHTML = `
    <div class="handle">⋮⋮</div>
    <input class="pName" type="text"   value="${p.name}"  title="Parteiname">
    <input class="pPct"  type="number" value="${p.pct}"   min="0" max="100" step="0.1" title="Prozent">
    <input class="pColor" type="color" value="${p.color}" title="Farbe">
    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#a6b0bf">
      <input type="checkbox" class="pExc" ${p.exception?"checked":""}> Ausnahme
    </label>
    <div class="del" title="Entfernen">✕</div>
  `;
  row.querySelector(".del").onclick = () => { row.remove(); calcAndRender(); };
  $("#partyList").appendChild(row);
  row.querySelectorAll("input").forEach(inp => inp.addEventListener("change", calcAndRender));
}

/* ===== Filter & Zuteilung ===== */
function filterByThreshold(parties, threshold, exceptions){
  return parties.filter(p =>
    p.name !== "Andere" && // Andere NIE zulassen
    p.pct > 0 &&
    (p.pct >= threshold || exceptions.includes(p.name) || p.exception)
  );
}

// Sainte-Laguë/Schepers
function sls(parties, seats){
  const factor = 1_000_000, Q=[];
  parties.forEach((p,i)=>{
    const v=p.pct*factor; for(let k=0;k<seats+5;k++){ Q.push({i,val:v/(k+0.5)}) }
  });
  Q.sort((a,b)=>b.val-a.val);
  const top=Q.slice(0,seats), c=new Array(parties.length).fill(0);
  top.forEach(q=>c[q.i]++); return c;
}

// d’Hondt
function dhondt(parties, seats){
  const factor = 1_000_000, Q=[];
  parties.forEach((p,i)=>{
    const v=p.pct*factor; for(let k=1;k<=seats;k++){ Q.push({i,val:v/k}) }
  });
  Q.sort((a,b)=>b.val-a.val);
  const top=Q.slice(0,seats), c=new Array(parties.length).fill(0);
  top.forEach(q=>c[q.i]++); return c;
}

// Hare-Niemeyer
function hareNiemeyer(parties, seats){
  const votes=parties.map(p=>p.pct), total=votes.reduce((a,b)=>a+b,0);
  if(total===0) return new Array(parties.length).fill(0);
  const quotas=votes.map(v=>v/total*seats);
  const base=quotas.map(q=>Math.floor(q));
  let assigned=base.reduce((a,b)=>a+b,0);
  const rem=quotas.map((q,i)=>({i,r:q-Math.floor(q)})).sort((a,b)=>b.r-a.r);
  for(let k=0; assigned<seats && k<rem.length; k++){ base[rem[k].i]++; assigned++; }
  return base;
}

function allocateSeats(parties, seats, method){
  if(method==="dhondt") return dhondt(parties, seats);
  if(method==="hare")   return hareNiemeyer(parties, seats);
  return sls(parties, seats);
}

function computeSeats(parties, seats, threshold, exceptions, method){
  const ok = filterByThreshold(parties, threshold, exceptions);
  const result = parties.map(p => ({...p, seats:0}));
  if(ok.length===0) return result;
  const counts = allocateSeats(ok, seats, method);
  ok.forEach((p, idx) => {
    const j = parties.findIndex(q => q.name===p.name && q.color===p.color && q.pct===p.pct);
    if(j>=0) result[j].seats = counts[idx];
  });
  // Sicherheit: Andere immer auf 0 setzen
  result.forEach(p => { if(p.name === "Andere") p.seats = 0; });
  return result;
}

/* ===== Layout + Render-Funktionen (wie gehabt) ===== */
// ... (bleibt unverändert, siehe dein Code oben, alles nach computeSeats bleibt gleich)
</script>
</body>
</html>
